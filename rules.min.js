let checkBonus={},weightKey={},bonusKey={};async function preloadRules(){try{const e=await fetch("rules.json");if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);const t=await e.json();checkBonus=t.checkBonus||{},weightKey=(t.weightKey||[]).reduce(((e,t)=>(e[t.name]=t.weight,e)),{}),bonusKey=(t.specialBonus||[]).reduce(((e,t)=>(e[t.name]=t.point,e)),{})}catch(e){console.error("Error loading rules.json:",e)}}preloadRules();var $={q:e=>document.querySelector(e),qa:e=>document.querySelectorAll(e),l:(e,t=document,...n)=>{t.addEventListener(e,(e=>{n.forEach((t=>t(e)))}))},rl:(e,t=document,...n)=>{t.removeEventListener(e,(e=>{n.forEach((t=>t(e)))}))},s:(e,t)=>{for(let n in t)t.hasOwnProperty(n)&&e.setAttribute(n,t[n])},c:(e,t,n,o,c)=>{var r=o?document.createElementNS(o,e):document.createElement(e);return t&&(r["img"===e||"video"===e||"audio"===e?"src":"innerHTML"]=t),n&&n.append(r),"img"===e&&(r.draggable=!1),c&&$.s(r,c),r}};function increment(e,t){if(t&&(t.preventDefault(),t.stopPropagation()),t&&t.shiftKey){const t=e.querySelector(".depth-label");if(t){const e=t.getAttribute("data-max"),n=parseInt(t.textContent);(!e||n<parseInt(e))&&(t.textContent=n+1)}}else{const t=e.querySelector(".counter-label");if(t){const e=t.getAttribute("data-max"),n=parseInt(t.textContent);(!e||n<parseInt(e))&&(t.textContent=n+1)}}}function decrement(e,t){if(t&&(t.preventDefault(),t.stopPropagation()),t&&t.shiftKey){const t=e.querySelector(".depth-label");t&&parseInt(t.textContent)>0&&(t.textContent=parseInt(t.textContent)-1)}else{const t=e.querySelector(".counter-label");t&&parseInt(t.textContent)>0&&(t.textContent=parseInt(t.textContent)-1)}}function selectAll(e){e.closest(".ban-weight").querySelectorAll('input[type="checkbox"]').forEach((e=>{e.checked=!0}))}function deselectAll(e){e.closest(".ban-weight").querySelectorAll('input[type="checkbox"]').forEach((e=>{e.checked=!e.checked}))}function updateBG(){const e=document.querySelectorAll('[class^="level"]');let t=0;if(e.forEach((e=>{const n=e.querySelectorAll("div.checked"),o=e.className.match(/\d+/);if(o&&n.length>0){const e=parseInt(o[0],10);e>t&&(t=e)}})),t>0){document.getElementById("bg").style.backgroundImage=`url('assets/HD/bg_zone_${t}.png')`}}$.l("click",document,(e=>{const t=e.target;t.classList.contains("check")&&(t.classList.add("checked"),increment(t,e))})),$.l("contextmenu",document,(e=>{const t=e.target,n=t.querySelector(".counter-label");n&&1!==parseInt(n.textContent)||t.classList.remove("checked"),decrement(t,e)}));let holeCount=0;function addHole(){const e=$.q(".limited-check"),t=document.querySelector('button[onclick="addHole()"]');e&&holeCount<5&&($.c("div",'\n            <span class="counter-label">0</span>\n            <span class="depth-label">0</span>\n        ',e,null,{class:"counter-box beyond",onclick:"increment(this, event)",oncontextmenu:"decrement(this, event); return false;"}),holeCount++,t.disabled=5===holeCount)}function rmvHole(){const e=$.q(".limited-check"),t=document.querySelector('button[onclick="addHole()"]');if(e){const t=e.querySelector(".counter-box.beyond");t&&(e.removeChild(t),holeCount--)}holeCount<5&&(t.disabled=!1),holeCount<=0&&(holeCount=0)}function getCheck(){const e=document.querySelectorAll("div.checked");return(e=>e.reduce(((e,t)=>{const n=checkBonus.find((e=>e.name===t.checkname));if(!n)return e;let o=n.baseScore,c=0;return t.checkboxStates.forEach((e=>{if(e.checked){const t=n.conditions[e.value]||0;o+="era"===e.id?Math.max(...e.value.split("/").map((e=>n.conditions[e]||0))):t,"no-leak"===e.id&&(c=t)}})),e+="鸭速公路"===t.checkname?o*t.counterValue-c*(t.counterValue-1):o}),0))(Array.from(e).map((e=>({counterValue:parseInt(e.querySelector(".counter-label")?.textContent||"1",10),checkboxStates:Array.from(e.querySelectorAll('input[type="checkbox"]')).map((e=>({id:e.id,value:e.value,checked:e.checked}))),checkname:e.querySelector("span.checkname")?.textContent.trim()||"defaultCheckname"}))))}function getOperation(){return(([e,t,n])=>(e>60?-50*(e-60):0)+-15*t+-6*n)(Array.from(document.querySelector("div.operation").querySelectorAll("input")).slice(0,3).map((e=>parseFloat(e.value))))}function getSpecial(){const e=document.querySelectorAll(".fortune .counter-box");return Array.from(e).map((e=>({class:e.classList[1],value:parseInt(e.querySelector("span.counter-label").textContent,10),depth:parseInt(e.querySelector("span.depth-label")?.textContent||0,10)}))).reduce(((e,{class:t,value:n,depth:o})=>{const c=bonusKey[t]*n;return e+("beyond"===t?c*o:c)}),0)}function getWeight(){let e=1,t=0;const n=document.querySelector(".bossfight").querySelectorAll("div.checked").length>0;return Array.from(document.querySelectorAll('.ban-weight input[type="checkbox"], .ban-weight select, .ban-weight input[type="radio"]')).forEach((({id:n,checked:o,value:c,type:r})=>{"radio"===r&&o?t="option-yes"===n?-1:"option-yee"===n?1:t:"checkbox"===r&&"doctor-silver"!==n&&o?e+=weightKey[n]||0:"select-one"===r&&"none"!==c&&(e+=weightKey[c]||0)})),-1===t?e*=.8:1===t&&(e+=weightKey[Object.keys(weightKey).pop()]),n?e.toFixed(4):-1===t?"0.8000":"1.0000"}function calcBonus(){let e=parseFloat(document.getElementById("origin-score").value),t=getCheck(),n=getOperation(),o=getSpecial(),c=getWeight(),r=(e+t+n+o)*c;r=parseFloat(r.toFixed(4));let l=`最终分数：[${e} + ${t} + (${n}) + ${o}) * ${c}] = ${r}`;$.q(".final-score").textContent=l}function saveAsImage(){html2canvas(document.body).then((e=>{const t=document.createElement("a");t.href=e.toDataURL("image/jpeg"),t.download="webpage-screenshot.jpg",t.click()}))}
