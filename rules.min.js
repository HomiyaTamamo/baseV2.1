let checkBonus={},weightKey={},bonusKey={};async function preloadRules(){try{const e=await fetch("rules.json");if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);const t=await e.json();checkBonus=t.checkBonus||{},weightKey=(t.weightKey||[]).reduce(((e,t)=>(e[t.name]=t.weight,e)),{}),bonusKey=(t.specialBonus||[]).reduce(((e,t)=>(e[t.name]=t.point,e)),{})}catch(e){console.error("Error loading rules.json:",e)}}preloadRules();var $={q:e=>document.querySelector(e),qa:e=>document.querySelectorAll(e),l:(e,t=document,...n)=>{t.addEventListener(e,(e=>{n.forEach((t=>t(e)))}))},rl:(e,t=document,...n)=>{t.removeEventListener(e,(e=>{n.forEach((t=>t(e)))}))},s:(e,t)=>{for(let n in t)t.hasOwnProperty(n)&&e.setAttribute(n,t[n])},c:(e,t,n,c,o)=>{var r=c?document.createElementNS(c,e):document.createElement(e);return t&&(r["img"===e||"video"===e||"audio"===e?"src":"innerHTML"]=t),n&&n.append(r),"img"===e&&(r.draggable=!1),o&&$.s(r,o),r}};function increment(e,t){if(t&&(t.preventDefault(),t.stopPropagation()),t&&t.shiftKey){const t=e.querySelector(".depth-label");if(t){const e=t.getAttribute("data-max"),n=parseInt(t.textContent);(!e||n<parseInt(e))&&(t.textContent=n+1)}}else{const t=e.querySelector(".counter-label");if(t){const e=t.getAttribute("data-max"),n=parseInt(t.textContent);(!e||n<parseInt(e))&&(t.textContent=n+1)}}}function decrement(e,t){if(t&&(t.preventDefault(),t.stopPropagation()),t&&t.shiftKey){const t=e.querySelector(".depth-label");t&&parseInt(t.textContent)>0&&(t.textContent=parseInt(t.textContent)-1)}else{const t=e.querySelector(".counter-label");t&&parseInt(t.textContent)>0&&(t.textContent=parseInt(t.textContent)-1)}}function selectAll(e){e.closest(".ban-weight").querySelectorAll('input[type="checkbox"]').forEach((e=>{e.checked=!0}))}function deselectAll(e){e.closest(".ban-weight").querySelectorAll('input[type="checkbox"]').forEach((e=>{e.checked=!e.checked}))}function updateBG(){const e=document.querySelectorAll('[class^="level"]');let t=0;if(e.forEach((e=>{const n=e.querySelectorAll("div.checked"),c=e.className.match(/\d+/);if(c&&n.length>0){const e=parseInt(c[0],10);e>t&&(t=e)}})),t>0){document.getElementById("bg").style.backgroundImage=`url('assets/HD/bg_zone_${t}.png')`}}function addHole(){const e=$.q(".limited-check");e&&$.c("div",'\n            <span class="counter-label">0</span>\n            <span class="depth-label">0</span>\n        ',e,null,{class:"counter-box beyond",onclick:"increment(this, event)",oncontextmenu:"decrement(this, event); return false;"})}function rmvHole(){const e=$.q(".limited-check");if(e){const t=e.querySelector(".counter-box.beyond");t&&e.removeChild(t)}}function getCheck(){const e=document.querySelectorAll("div.checked");return(e=>e.reduce(((e,t)=>{const n=checkBonus.find((e=>e.name===t.checkname));if(!n)return e;let c=n.baseScore,o=0;return t.checkboxStates.forEach((e=>{if(e.checked){const t=n.conditions[e.value]||0;c+="era"===e.id?Math.max(...e.value.split("/").map((e=>n.conditions[e]||0))):t,"no-leak"===e.id&&(o=t)}})),e+="鸭速公路"===t.checkname?c*t.counterValue-o*(t.counterValue-1):c}),0))(Array.from(e).map((e=>({counterValue:parseInt(e.querySelector(".counter-label")?.textContent||"1",10),checkboxStates:Array.from(e.querySelectorAll('input[type="checkbox"]')).map((e=>({id:e.id,value:e.value,checked:e.checked}))),checkname:e.querySelector("span.checkname")?.textContent.trim()||"defaultCheckname"}))))}function getOperation(){const e=document.querySelector("div.operation");return(e=>{let t=0;return e[0]>60&&(t-=50*(e[0]-60)),t+=-15*e[1],t+=-6*e[2],t})(Array.from(e.querySelectorAll("input")).slice(0,3).map((e=>parseFloat(e.value))))}function getSpecial(){const e=document.querySelectorAll(".fortune .counter-box");return Array.from(e).map((e=>({class:e.classList[1],value:parseInt(e.querySelector("span.counter-label").textContent,10),depth:parseInt(e.querySelector("span.depth-label")?.textContent||0,10)}))).reduce(((e,{class:t,value:n,depth:c})=>{const o=bonusKey[t]*n;return e+("beyond"===t?o*c:o)}),0)}function getWeight(){let e=1,t=0;const n=document.querySelector(".bossfight").querySelectorAll("div.checked").length>0;return Array.from(document.querySelectorAll('.ban-weight input[type="checkbox"], .ban-weight select, .ban-weight input[type="radio"]')).forEach((({id:n,checked:c,value:o,type:r})=>{"radio"===r&&c?t="option-yes"===n?-1:"option-yee"===n?1:t:"checkbox"===r&&"doctor-silver"!==n&&c?e+=weightKey[n]||0:"select-one"===r&&"none"!==o&&(e+=weightKey[o]||0)})),-1===t?e*=.8:1===t&&(e+=weightKey[Object.keys(weightKey).pop()]),n?e.toFixed(4):-1===t?"0.8000":"1.0000"}function calcBonus(){let e=parseFloat(document.getElementById("origin-score").value),t=getCheck(),n=getOperation(),c=getSpecial(),o=getWeight(),r=(e+t+n+c)*o;r=parseFloat(r.toFixed(4));let l=`最终分数：[${e} + ${t} + (${n}) + ${c}) * ${o}] = ${r}`;$.q(".final-score").textContent=l}$.l("click",document,(e=>{const t=e.target;t.classList.contains("check")&&(t.classList.add("checked"),increment(t,e))})),$.l("contextmenu",document,(e=>{const t=e.target,n=t.querySelector(".counter-label");n&&1!==parseInt(n.textContent)||t.classList.remove("checked"),decrement(t,e)}));